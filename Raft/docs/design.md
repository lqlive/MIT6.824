# Raft å…±è¯†ç®—æ³•å®ç° - è®¾è®¡æ–‡æ¡£

æœ¬æ–‡æ¡£æä¾›äº†Raftç®—æ³•å®ç°çš„è¯¦ç»†è®¾è®¡å’Œå¼€å‘æŒ‡å—ï¼Œå¸®åŠ©æ‚¨äº†è§£å½“å‰è¿›åº¦å¹¶ç»§ç»­å®Œæˆå‰©ä½™éƒ¨åˆ†ã€‚

## ğŸ“ é¡¹ç›®æ¶æ„

```
Raft/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Raft.Common/         # ğŸ”§ å…¬å…±ç»„ä»¶å’Œæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ Models/          # æ•°æ®æ¨¡å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ Interfaces/      # æ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ Raft.Server/         # ğŸ–¥ï¸ RaftèŠ‚ç‚¹å®ç°
â”‚   â”œâ”€â”€ Raft.Client/         # ğŸ‘¤ Raftå®¢æˆ·ç«¯å®ç°
â”‚   â””â”€â”€ Raft.Tests/          # ğŸ§ª å•å…ƒæµ‹è¯•
â”œâ”€â”€ docs/                    # ğŸ“š æ–‡æ¡£
â”œâ”€â”€ examples/                # ğŸ’¡ ç¤ºä¾‹è„šæœ¬
â””â”€â”€ Raft.sln                # Visual Studioè§£å†³æ–¹æ¡ˆ
```

## âœ… å½“å‰å®ŒæˆçŠ¶æ€

### ğŸ”§ Raft.Common - å…¬å…±ç»„ä»¶ âœ…
- âœ… **RaftNodeState** - èŠ‚ç‚¹çŠ¶æ€æšä¸¾(Follower/Candidate/Leader)
- âœ… **LogEntry** - æ—¥å¿—æ¡ç›®æ¨¡å‹
- âœ… **VoteRequest/VoteResponse** - RequestVote RPCæ¶ˆæ¯
- âœ… **AppendEntriesRequest/AppendEntriesResponse** - AppendEntries RPCæ¶ˆæ¯
- âœ… **IRaftNode** - RaftèŠ‚ç‚¹æ ¸å¿ƒæ¥å£

### ğŸ–¥ï¸ Raft.Server - èŠ‚ç‚¹å®ç° âœ…
- âœ… **RaftNodeç±»** - åŸºç¡€RaftèŠ‚ç‚¹å®ç°
- âœ… **çŠ¶æ€ç®¡ç†** - èŠ‚ç‚¹çŠ¶æ€è½¬æ¢é€»è¾‘
- âœ… **RequestVote RPC** - æŠ•ç¥¨è¯·æ±‚å¤„ç†
- âœ… **AppendEntries RPC** - æ—¥å¿—è¿½åŠ å’Œå¿ƒè·³å¤„ç†(åŸºç¡€ç‰ˆæœ¬)
- âœ… **é€‰ä¸¾è¶…æ—¶æœºåˆ¶** - åŸºç¡€è¶…æ—¶å¤„ç†
- âœ… **ä»»æœŸç®¡ç†** - CurrentTermç®¡ç†

### ğŸ‘¤ Raft.Client - å®¢æˆ·ç«¯å®ç° âœ…
- âœ… **RaftClientç±»** - å®¢æˆ·ç«¯æ ¸å¿ƒå®ç°
- âœ… **Leaderå‘ç°** - è‡ªåŠ¨å‘ç°é›†ç¾¤LeaderèŠ‚ç‚¹
- âœ… **å‘½ä»¤æäº¤** - å‘Leaderæäº¤å‘½ä»¤
- âœ… **é›†ç¾¤çŠ¶æ€æŸ¥è¯¢** - è·å–æ•´ä¸ªé›†ç¾¤çŠ¶æ€
- âœ… **é”™è¯¯å¤„ç†** - Leaderé‡å®šå‘å’Œæ•…éšœæ¢å¤
- âœ… **äº¤äº’å¼æ§åˆ¶å°** - å‘½ä»¤è¡Œå®¢æˆ·ç«¯å·¥å…·

### ğŸ§ª Raft.Tests - æµ‹è¯•å¥—ä»¶ âœ…
- âœ… **RaftNodeåŸºç¡€æµ‹è¯•** - èŠ‚ç‚¹åˆå§‹åŒ–å’ŒçŠ¶æ€æµ‹è¯•
- âœ… **æŠ•ç¥¨æœºåˆ¶æµ‹è¯•** - RequestVote RPCæµ‹è¯•
- âœ… **æ—¥å¿—è¿½åŠ æµ‹è¯•** - AppendEntries RPCæµ‹è¯•
- âœ… **RaftClientæµ‹è¯•** - å®¢æˆ·ç«¯åŠŸèƒ½æµ‹è¯•
- âœ… **TestLoggerå®ç°** - è‡ªå®šä¹‰æµ‹è¯•æ—¥å¿—å™¨

## ğŸš§ ä¸‹ä¸€æ­¥å¼€å‘è®¡åˆ’

### Part 2A: Leaderé€‰ä¸¾ (ä¼˜å…ˆçº§: ğŸ”´ HIGH)

**éœ€è¦å®Œå–„çš„åŠŸèƒ½ï¼š**

1. **å®Œæ•´çš„é€‰ä¸¾é€»è¾‘** ğŸ“‹
   ```csharp
   // åœ¨ RaftNode.cs çš„ StartElection() æ–¹æ³•ä¸­å®ç°ï¼š
   // - å‘æ‰€æœ‰peerå‘é€RequestVote RPC
   // - å¹¶è¡Œæ”¶é›†æŠ•ç¥¨ç»“æœ
   // - ç»Ÿè®¡é€‰ç¥¨æ•°é‡
   // - å¦‚æœè·å¾—å¤šæ•°é€‰ç¥¨ï¼Œæˆä¸ºLeader
   ```

2. **Leaderå¿ƒè·³æœºåˆ¶** ğŸ“‹
   ```csharp
   // å®ç°Leaderçš„å¿ƒè·³å‘é€ï¼š
   // - å¯åŠ¨å¿ƒè·³å®šæ—¶å™¨
   // - å®šæœŸå‘æ‰€æœ‰Followerå‘é€ç©ºçš„AppendEntries
   // - ç»´æŒLeaderæƒå¨æ€§
   ```

3. **ç½‘ç»œé€šä¿¡å±‚** ğŸ“‹
   ```csharp
   // åˆ›å»º IRaftCommunication æ¥å£
   // å®ç°HTTP/gRPCé€šä¿¡
   // å¤„ç†èŠ‚ç‚¹é—´çš„RPCè°ƒç”¨
   ```

### Part 2B: æ—¥å¿—å¤åˆ¶ (ä¼˜å…ˆçº§: ğŸŸ¡ MEDIUM)

**éœ€è¦å®ç°çš„åŠŸèƒ½ï¼š**

1. **æ—¥å¿—ä¸€è‡´æ€§æ£€æŸ¥**
   ```csharp
   // åœ¨AppendEntriesä¸­å®ç°ï¼š
   // - æ£€æŸ¥PrevLogIndexå’ŒPrevLogTerm
   // - å¤„ç†æ—¥å¿—å†²çª
   // - å®ç°æ—¥å¿—å›é€€æœºåˆ¶
   ```

2. **å®¢æˆ·ç«¯å‘½ä»¤å¤„ç†**
   ```csharp
   // å®Œå–„SubmitCommandAsyncæ–¹æ³•ï¼š
   // - æ·»åŠ æ—¥å¿—æ¡ç›®
   // - å¤åˆ¶åˆ°å¤§å¤šæ•°èŠ‚ç‚¹
   // - æäº¤å¹¶åº”ç”¨åˆ°çŠ¶æ€æœº
   ```

3. **çŠ¶æ€æœºé›†æˆ**
   ```csharp
   // å®ç°çŠ¶æ€æœºæ¥å£
   // åº”ç”¨å·²æäº¤çš„æ—¥å¿—æ¡ç›®
   ```

### Part 2C: æŒä¹…åŒ– (ä¼˜å…ˆçº§: ğŸŸ¢ LOW)

**éœ€è¦å®ç°çš„åŠŸèƒ½ï¼š**

1. **çŠ¶æ€æŒä¹…åŒ–**
   ```csharp
   // æŒä¹…åŒ–å…³é”®çŠ¶æ€ï¼š
   // - currentTerm
   // - votedFor  
   // - log[]
   ```

2. **æ•…éšœæ¢å¤**
   ```csharp
   // èŠ‚ç‚¹é‡å¯æ—¶æ¢å¤çŠ¶æ€
   // é‡å»ºå†…å­˜ä¸­çš„æ•°æ®ç»“æ„
   ```

## ğŸ› ï¸ ç«‹å³å¯ä»¥å¼€å§‹çš„ä»»åŠ¡

### ä»»åŠ¡1: å®ç°ç½‘ç»œé€šä¿¡å±‚ï¼ˆæ¨èä¼˜å…ˆå¼€å§‹ï¼‰

åˆ›å»ºæ–‡ä»¶ï¼š`src/Raft.Common/Interfaces/IRaftCommunication.cs`

```csharp
public interface IRaftCommunication
{
    Task<VoteResponse> SendRequestVoteAsync(string targetNodeId, VoteRequest request);
    Task<AppendEntriesResponse> SendAppendEntriesAsync(string targetNodeId, AppendEntriesRequest request);
}
```

### ä»»åŠ¡2: å®Œå–„é€‰ä¸¾é€»è¾‘

åœ¨ `RaftNode.cs` çš„ `StartElection` æ–¹æ³•ä¸­ï¼š

```csharp
private async Task StartElection()
{
    // 1. å‘æ‰€æœ‰peerå¹¶è¡Œå‘é€æŠ•ç¥¨è¯·æ±‚
    // 2. ç­‰å¾…å“åº”å¹¶ç»Ÿè®¡é€‰ç¥¨
    // 3. å¦‚æœè·å¾—å¤šæ•°é€‰ç¥¨ï¼Œæˆä¸ºLeader
    // 4. å¦‚æœé€‰ä¸¾è¶…æ—¶ï¼Œé‡æ–°å¼€å§‹é€‰ä¸¾
}
```

### ä»»åŠ¡3: å®ç°Leaderå¿ƒè·³

```csharp
private async Task SendHeartbeats()
{
    // å®šæœŸå‘æ‰€æœ‰Followerå‘é€å¿ƒè·³
    // æ£€æµ‹Followeræ˜¯å¦ç¦»çº¿
    // ç»´æŒLeaderæƒå¨æ€§
}
```

## ğŸƒâ€â™‚ï¸ å¿«é€Ÿå¼€å§‹

### æ„å»ºé¡¹ç›®
```bash
cd Raft
dotnet build
```

### è¿è¡Œæµ‹è¯•
```bash
dotnet test
```

### è¿è¡Œå®¢æˆ·ç«¯
```bash
cd src/Raft.Client
dotnet run localhost:5001,localhost:5002,localhost:5003
```

æˆ–ä½¿ç”¨ç¤ºä¾‹è„šæœ¬ï¼š
```bash
./examples/run-client.ps1
```

## ğŸ“‹ å¼€å‘ä»»åŠ¡æ¸…å•

### ç«‹å³æ‰§è¡Œ (æœ¬å‘¨)
- [ ] å®ç°`IRaftCommunication`æ¥å£
- [ ] å®Œå–„`StartElection`æ–¹æ³•
- [ ] æ·»åŠ é€‰ä¸¾è¶…æ—¶éšæœºåŒ–
- [ ] å®ç°åŸºç¡€çš„HTTP API

### çŸ­æœŸç›®æ ‡ (2-3å‘¨)
- [ ] å®ŒæˆLeaderé€‰ä¸¾åŠŸèƒ½
- [ ] å®ç°åŸºç¡€æ—¥å¿—å¤åˆ¶
- [ ] æ·»åŠ æ›´å¤šé›†æˆæµ‹è¯•
- [ ] åˆ›å»ºæ¼”ç¤ºåº”ç”¨

### é•¿æœŸç›®æ ‡ (1-2æœˆ)
- [ ] å®Œæˆå®Œæ•´çš„Raftå®ç°
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
- [ ] æ–‡æ¡£å®Œå–„
- [ ] éƒ¨ç½²ç¤ºä¾‹

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- ä¸ºæ¯ä¸ªæ–°åŠŸèƒ½ç¼–å†™å•å…ƒæµ‹è¯•
- æµ‹è¯•å„ç§è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µ

### é›†æˆæµ‹è¯•
- åˆ›å»ºå¤šèŠ‚ç‚¹é›†ç¾¤æµ‹è¯•
- æ¨¡æ‹Ÿç½‘ç»œåˆ†åŒºå’ŒèŠ‚ç‚¹æ•…éšœ

### ç¤ºä¾‹æµ‹è¯•åœºæ™¯
```csharp
[Fact]
public async Task Election_WithThreeNodes_ShouldElectLeader()
{
    // åˆ›å»º3ä¸ªèŠ‚ç‚¹
    // æ–­å¼€ä¸€ä¸ªèŠ‚ç‚¹çš„ç½‘ç»œ
    // éªŒè¯å‰©ä½™ä¸¤ä¸ªèŠ‚ç‚¹èƒ½é€‰å‡ºLeader
}
```

## ğŸ” è°ƒè¯•å’Œæµ‹è¯•

### æµ‹è¯•å‘½ä»¤
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
dotnet test

# è¿è¡Œç‰¹å®šæµ‹è¯•ç±»
dotnet test --filter "RaftNodeTests"

# è¯¦ç»†è¾“å‡º
dotnet test --logger "console;verbosity=detailed"
```

### æ—¥å¿—é…ç½®
é¡¹ç›®ä½¿ç”¨Microsoft.Extensions.Loggingï¼Œæ”¯æŒä¸åŒæ—¥å¿—çº§åˆ«ï¼š
- `Trace` - è¯¦ç»†è°ƒè¯•ä¿¡æ¯
- `Debug` - è°ƒè¯•ä¿¡æ¯
- `Information` - ä¸€èˆ¬ä¿¡æ¯ (é»˜è®¤)
- `Warning` - è­¦å‘Šä¿¡æ¯
- `Error` - é”™è¯¯ä¿¡æ¯

## ğŸ“š å­¦ä¹ èµ„æº

- [Raftè®ºæ–‡åŸæ–‡](https://raft.github.io/raft.pdf)
- [Raftå¯è§†åŒ–](https://raft.github.io/)
- [MIT 6.824è¯¾ç¨‹](https://pdos.csail.mit.edu/6.824/)
- [Raftç®—æ³•è¯¦è§£](https://www.cnblogs.com/mindwind/p/5231986.html)

## ğŸ¯ ç¼–ç è§„èŒƒ

1. **å‘½åçº¦å®š**
   - ç±»åä½¿ç”¨PascalCase
   - æ–¹æ³•åä½¿ç”¨PascalCase
   - ç§æœ‰å­—æ®µä½¿ç”¨_å¼€å¤´çš„camelCase
   - å¸¸é‡ä½¿ç”¨UPPER_CASE

2. **å¼‚æ­¥ç¼–ç¨‹**
   - æ‰€æœ‰I/Oæ“ä½œä½¿ç”¨async/await
   - æ–¹æ³•åä»¥Asyncç»“å°¾
   - ä¼ é€’CancellationToken

3. **é”™è¯¯å¤„ç†**
   - ä½¿ç”¨å¼‚å¸¸å¤„ç†å…³é”®é”™è¯¯
   - ä½¿ç”¨Resultæ¨¡å¼å¤„ç†ä¸šåŠ¡é€»è¾‘é”™è¯¯
   - æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•

4. **æµ‹è¯•ç­–ç•¥**
   - æ¯ä¸ªå…¬å…±æ–¹æ³•éƒ½è¦æœ‰å¯¹åº”æµ‹è¯•
   - ä½¿ç”¨Arrange-Act-Assertæ¨¡å¼
   - æµ‹è¯•æ–¹æ³•åè¦æ¸…æ¥šæè¿°æµ‹è¯•åœºæ™¯

## ğŸ¯ é‡Œç¨‹ç¢‘ç›®æ ‡

- **ç¬¬1å‘¨**ï¼šå®Œæˆç½‘ç»œé€šä¿¡å±‚å’Œå®Œæ•´çš„é€‰ä¸¾æœºåˆ¶
- **ç¬¬2å‘¨**ï¼šå®ç°åŸºç¡€çš„æ—¥å¿—å¤åˆ¶åŠŸèƒ½  
- **ç¬¬3å‘¨**ï¼šæ·»åŠ æŒä¹…åŒ–æ”¯æŒ
- **ç¬¬4å‘¨**ï¼šæ€§èƒ½ä¼˜åŒ–å’Œå…¨é¢æµ‹è¯•

## ğŸ¤ è·å–å¸®åŠ©

å¦‚æœåœ¨å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š

1. æŸ¥çœ‹MIT 6.824è¯¾ç¨‹å®˜æ–¹èµ„æ–™
2. å‚è€ƒRaftè®ºæ–‡çš„å…·ä½“å®ç°æŒ‡å¯¼
3. åˆ†æç°æœ‰çš„å¼€æºRaftå®ç°
4. é€æ­¥è°ƒè¯•å’Œæµ‹è¯•æ¯ä¸ªç»„ä»¶

---

**å½“å‰è¿›åº¦: åŸºç¡€æ¡†æ¶å®Œæˆ âœ… | ä¸‹ä¸€æ­¥: å®ç°Leaderé€‰ä¸¾ ğŸ¯**

å¼€å§‹ç¼–ç å§ï¼ğŸš€ 